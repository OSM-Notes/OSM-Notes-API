groups:
  - name: osm_notes_api_alerts
    interval: 30s
    rules:
      # Alert: High Error Rate
      - alert: HighErrorRate
        expr: rate(http_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: 'High error rate detected'
          description:
            'Error rate is {{ $value }} errors/sec (threshold: 10 errors/sec) for the last 5 minutes'

      # Alert: Very High Error Rate (Critical)
      - alert: VeryHighErrorRate
        expr: rate(http_errors_total[5m]) > 50
        for: 2m
        labels:
          severity: critical
          service: api
        annotations:
          summary: 'Very high error rate detected'
          description:
            'Error rate is {{ $value }} errors/sec (threshold: 50 errors/sec) for the last 2 minutes'

      # Alert: High Latency (P95)
      - alert: HighLatencyP95
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: 'High latency detected (P95)'
          description: 'P95 latency is {{ $value }}s (threshold: 2s) for the last 5 minutes'

      # Alert: Very High Latency (P95) - Critical
      - alert: VeryHighLatencyP95
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 5
        for: 2m
        labels:
          severity: critical
          service: api
        annotations:
          summary: 'Very high latency detected (P95)'
          description: 'P95 latency is {{ $value }}s (threshold: 5s) for the last 2 minutes'

      # Alert: High Latency (P99)
      - alert: HighLatencyP99
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: 'High latency detected (P99)'
          description: 'P99 latency is {{ $value }}s (threshold: 5s) for the last 5 minutes'

      # Alert: Frequent Rate Limiting
      - alert: FrequentRateLimiting
        expr: rate(rate_limit_exceeded_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: 'Frequent rate limiting detected'
          description:
            'Rate limit exceeded {{ $value }} times/sec (threshold: 5/sec) for the last 5 minutes'

      # Alert: Very Frequent Rate Limiting (Possible Attack)
      - alert: VeryFrequentRateLimiting
        expr: rate(rate_limit_exceeded_total[1m]) > 20
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: 'Very frequent rate limiting detected (possible attack)'
          description:
            'Rate limit exceeded {{ $value }} times/sec (threshold: 20/sec) for the last minute.
            Possible DDoS or abuse attack.'

      # Alert: API Down
      - alert: APIDown
        expr: up{job="osm-notes-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: 'API is down'
          description: 'API has been down for more than 1 minute'

      # Alert: High Request Rate (Possible DDoS)
      - alert: HighRequestRate
        expr: rate(http_requests_total[1m]) > 1000
        for: 2m
        labels:
          severity: warning
          service: api
        annotations:
          summary: 'High request rate detected'
          description:
            'Request rate is {{ $value }} requests/sec (threshold: 1000/sec) for the last 2 minutes'
