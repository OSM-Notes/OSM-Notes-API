#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook for OSM-Notes-API
# Unified Git hook for TypeScript/JavaScript projects
# Author: Andres Gomez (AngocA)
# Version: 2026-01-27
# Runs tests before allowing push
#
# This hook runs:
# 1. Type checking
# 2. Linting
# 3. Unit tests (light mode)

set -e  # Exit on error

echo "üöÄ Running pre-push validation..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check 1: Linting (fast - only staged files)
echo -e "${BLUE}üîß Running linter (staged files only)...${NC}"
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)
if [ -n "$STAGED_TS_FILES" ]; then
    # Lint only staged files for speed
    if echo "$STAGED_TS_FILES" | xargs npx eslint --max-warnings=0 > /tmp/pre-push-lint.log 2>&1; then
        echo -e "${GREEN}‚úÖ Linter passed${NC}"
    else
        echo -e "${RED}‚ùå Linter found issues${NC}"
        head -30 /tmp/pre-push-lint.log
        exit 1
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  No TypeScript files staged, skipping lint...${NC}"
fi
echo ""

# Check 2: Type checking (fast - incremental, with timeout)
echo -e "${BLUE}üîç Running type check (incremental, max 60s)...${NC}"
if timeout 60 npm run type-check > /tmp/pre-push-typecheck.log 2>&1; then
    echo -e "${GREEN}‚úÖ Type check passed${NC}"
else
    TIMEOUT_EXIT=$?
    if [ $TIMEOUT_EXIT -eq 124 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Type check timed out (taking too long), skipping...${NC}"
        echo -e "${YELLOW}   Run manually: npm run type-check${NC}"
    else
        echo -e "${RED}‚ùå Type check failed${NC}"
        head -30 /tmp/pre-push-typecheck.log
        exit 1
    fi
fi
echo ""

# Check 3: Unit tests (light mode - fast tests only, optional with timeout)
if grep -q "test:light" package.json 2>/dev/null; then
    echo -e "${BLUE}üß™ Running unit tests (light mode, optional, max 30s)...${NC}"
    if timeout 30 npm run test:light > /tmp/pre-push-tests.log 2>&1; then
        echo -e "${GREEN}‚úÖ Unit tests passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Unit tests skipped (timeout or not available)${NC}"
    fi
    echo ""
fi

echo -e "${GREEN}‚úÖ Pre-push validation complete!${NC}"
echo ""

exit 0
