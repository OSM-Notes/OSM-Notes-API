#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook: Run code quality checks before commit
# This hook ensures code quality by running:
# 1. ESLint (linting)
# 2. TypeScript type checking
# 3. Prettier format checking (JS/TS/MD/JSON/YAML/CSS/HTML)
# 4. Python formatting (Black/Ruff) if Python files are staged

set -e  # Exit on error

echo "üîç Running pre-commit checks..."

echo "üìù Checking code formatting..."
npm run format:check

# Check for staged files that Prettier should format
STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|json|yaml|yml|css|html)$' || true)
if [ -n "$STAGED_FORMAT_FILES" ]; then
    echo "üìù Checking Prettier formatting for other file types..."
    for file in $STAGED_FORMAT_FILES; do
        if [ -f "$file" ]; then
            npx prettier --check "$file" || {
                echo "‚ùå Prettier format check failed for: $file"
                echo "   Run: npx prettier --write $file"
                exit 1
            }
        fi
    done
fi

# Check for Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
if [ -n "$STAGED_PY_FILES" ]; then
    echo "üêç Checking Python formatting..."
    if command -v black &> /dev/null; then
        for file in $STAGED_PY_FILES; do
            if [ -f "$file" ]; then
                black --check --line-length 100 "$file" || {
                    echo "‚ùå Black format check failed for: $file"
                    echo "   Run: black --line-length 100 $file"
                    exit 1
                }
            fi
        done
    elif command -v ruff &> /dev/null; then
        for file in $STAGED_PY_FILES; do
            if [ -f "$file" ]; then
                ruff check "$file" || {
                    echo "‚ùå Ruff check failed for: $file"
                    echo "   Run: ruff check --fix $file"
                    exit 1
                }
            fi
        done
    else
        echo "‚ö†Ô∏è  Black/Ruff not installed, skipping Python format check..."
    fi
fi

echo "üîß Running linter..."
npm run lint

echo "‚úÖ Running type check..."
npm run type-check

echo "‚úÖ All pre-commit checks passed!"
